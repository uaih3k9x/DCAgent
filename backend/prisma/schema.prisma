// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 数据中心
model DataCenter {
  id        String   @id @default(uuid())
  shortId   Int      @unique @default(autoincrement()) // 短ID用于二维码和手动输入
  name      String
  location  String?
  rooms     Room[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 机房
model Room {
  id           String     @id @default(uuid())
  shortId      Int        @unique @default(autoincrement()) // 短ID
  name         String
  floor        String?
  dataCenterId String
  dataCenter   DataCenter @relation(fields: [dataCenterId], references: [id], onDelete: Cascade)
  cabinets     Cabinet[]
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

// 机柜
model Cabinet {
  id        String   @id @default(uuid())
  shortId   Int      @unique @default(autoincrement()) // 短ID
  name      String
  position  String?  // 机房中的位置
  height    Int      @default(42) // U数，默认42U
  roomId    String
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  devices   Device[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 设备类型枚举
enum DeviceType {
  SERVER
  SWITCH
  ROUTER
  FIREWALL
  STORAGE
  PDU
  OTHER
}

// 设备
model Device {
  id          String     @id @default(uuid())
  shortId     Int        @unique @default(autoincrement()) // 短ID
  name        String
  type        DeviceType
  model       String?
  serialNo    String?    @unique
  uPosition   Int?       // 在机柜中的U位
  uHeight     Int?       // 占用几U
  cabinetId   String
  cabinet     Cabinet    @relation(fields: [cabinetId], references: [id], onDelete: Cascade)
  panels      Panel[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

// 面板类型枚举
enum PanelType {
  NETWORK      // 网络面板（可包含RJ45, SFP, QSFP等混合端口）
  POWER        // 电源面板
  CONSOLE      // 控制台/串口面板
  USB          // USB面板
  MIXED        // 混合功能面板
  OTHER        // 其他
}

// 面板模板（可复用的面板配置）
model PanelTemplate {
  id              String    @id @default(uuid())
  name            String    // 模板名称，如 "24口交换机面板"
  type            PanelType // 面板类型
  portCount       Int       // 端口数量
  description     String?   // 模板描述
  // 物理尺寸（单位：mm）
  width           Float     @default(482.6) // 标准1U面板宽度
  height          Float     @default(44.45) // 标准1U面板高度
  // 布局配置（JSON存储）
  layoutConfig    Json?     // 布局规则配置：{ portsPerRow, rowSpacing, portSize, spacing }
  // 端口定义（JSON数组）
  portDefinitions Json      // 端口定义数组：[{ number, position: {x,y}, size: {width,height} }]
  // 视觉样式
  backgroundColor String?   // 背景颜色
  image           String?   // 图片URL
  svgPath         String?   // SVG路径
  // 是否为系统预设模板
  isSystem        Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  // 使用该模板的面板
  panels          Panel[]
}

// 面板（设备上的接口面板）
model Panel {
  id              String         @id @default(uuid())
  name            String
  type            PanelType
  shortId         Int?           @unique // 面板shortID，用于快速识别和扫码
  deviceId        String
  device          Device         @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  ports           Port[]
  // 模板引用（可选）
  templateId      String?
  template        PanelTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  isCustomized    Boolean        @default(false) // 是否已从模板自定义（解绑）
  // 物理布局信息（单位：mm）
  position        Json?          // 位置坐标 {x, y}
  size            Json?          // 尺寸 {width, height}
  // 视觉样式
  backgroundColor String?        // 背景颜色
  image           String?        // 图片URL
  svgPath         String?        // SVG路径
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

// 端口状态枚举
enum PortStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  FAULTY
}

// 端口
model Port {
  id        String          @id @default(uuid())
  shortId   Int             @unique @default(autoincrement()) // 短ID用于二维码和手动输入
  number    String          // 端口编号
  label     String?         // 端口标签
  status    PortStatus      @default(AVAILABLE)
  panelId   String
  panel     Panel           @relation(fields: [panelId], references: [id], onDelete: Cascade)
  portType  String?         // 端口类型 (RJ45, SFP, SFP+, QSFP, 等)
  rotation  Float?          @default(0) // 旋转角度 (0, 90, 180, 270)
  // 物理布局信息（相对于面板的坐标，单位：mm）
  position  Json?           // 位置坐标 {x, y}
  size      Json?           // 尺寸 {width, height}
  // 连接信息
  cableEndpoints CableEndpoint[] // 该端口连接的线缆端点
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@unique([panelId, number])
}

// 线缆类型枚举
enum CableType {
  CAT5E
  CAT6
  CAT6A
  CAT7
  FIBER_SM       // 单模光纤
  FIBER_MM       // 多模光纤
  QSFP_TO_SFP    // QSFP转SFP分支线缆
  QSFP_TO_QSFP   // QSFP直连
  SFP_TO_SFP     // SFP直连
  POWER
  OTHER
}

// 线缆入库状态枚举
enum CableInventoryStatus {
  NOT_INVENTORIED  // 未入库（线缆记录存在但未绑定端口）
  INVENTORIED      // 已入库（已绑定端口，待连接）
  IN_USE           // 使用中（已连接端口并在用）
}

// 线缆（基础信息存储在关系数据库，连接关系存储在Neo4j）
model Cable {
  id               String                @id @default(uuid())
  shortId          Int                   @unique @default(autoincrement()) // 短ID用于二维码
  label            String?               // 线缆标签
  type             CableType
  length           Float?                // 长度（米）
  color            String?
  notes            String?
  isBranched       Boolean               @default(false) // 是否为分支线缆（1对多）
  inventoryStatus  CableInventoryStatus  @default(NOT_INVENTORIED) // 入库状态
  endpoints        CableEndpoint[]       // 线缆端点
  shortIdPools     CableShortIdPool[]    // shortID池关联（用于预分配ID）
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt
}

// 线缆端点（支持1对多连接）
model CableEndpoint {
  id        String   @id @default(uuid())
  cableId   String
  cable     Cable    @relation(fields: [cableId], references: [id], onDelete: Cascade)
  portId    String
  port      Port     @relation(fields: [portId], references: [id], onDelete: Cascade)
  endType   String   // "A" 表示主端（如QSFP端），"B1", "B2", "B3", "B4" 表示分支端（如4个SFP端）
  createdAt DateTime @default(now())

  @@unique([cableId, endType]) // 确保同一线缆的端点类型唯一
}

// ShortID池状态枚举
enum ShortIdPoolStatus {
  GENERATED   // 已生成（刚创建）
  PRINTED     // 已打印（被打印任务标记）
  BOUND       // 已绑定（已绑定到实体）
  CANCELLED   // 已报废（标签损坏、丢失等）
}

// 实体类型枚举（所有使用shortID的实体）
enum EntityType {
  DATA_CENTER
  ROOM
  CABINET
  DEVICE
  PANEL
  PORT
  CABLE
}

// 打印任务表
model PrintTask {
  id          String         @id @default(uuid())
  name        String         // 任务名称，如 "2025年第一批标签"
  count       Int            // 打印数量
  status      String         @default("PENDING") // PENDING/PRINTING/COMPLETED/FAILED
  filePath    String?        // 导出文件路径（CSV/Excel）
  notes       String?        // 备注
  shortIds    ShortIdPool[]  // 关联的shortID
  createdBy   String?        // 创建人
  createdAt   DateTime       @default(now())
  completedAt DateTime?      // 完成时间
  updatedAt   DateTime       @updatedAt
}

// 统一的ShortID池（用于预先打印标签）
model ShortIdPool {
  id           String             @id @default(uuid())
  shortId      Int                @unique  // 预分配的shortID
  status       ShortIdPoolStatus  @default(GENERATED) // 状态

  // 绑定信息（使用时填充）
  entityType   EntityType?        // 绑定时的实体类型
  entityId     String?            // 绑定的实体ID
  boundAt      DateTime?          // 绑定时间

  // 打印任务关联
  printTaskId  String?
  printTask    PrintTask?         @relation(fields: [printTaskId], references: [id], onDelete: SetNull)
  printedAt    DateTime?          // 打印时间

  // 其他信息
  batchNo      String?            // 批次号
  notes        String?            // 备注（如作废原因等）

  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  @@index([entityType, status])
  @@index([shortId])
  @@index([status])
}

// 为了保持向后兼容，Cable表的shortIdPools关系暂时保留
// 后续会迁移到统一的ShortIdPool表
model CableShortIdPool {
  id          String        @id @default(uuid())
  shortId     Int           @unique
  status      String        @default("AVAILABLE")
  cableId     String?       @unique
  cable       Cable?        @relation(fields: [cableId], references: [id], onDelete: SetNull)
  allocatedAt DateTime      @default(now())
  usedAt      DateTime?
  notes       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}
