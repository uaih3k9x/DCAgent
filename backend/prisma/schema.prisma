// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 数据中心
model DataCenter {
  id        String   @id @default(uuid())
  shortId   Int      @unique @default(autoincrement()) // 短ID用于二维码和手动输入
  name      String
  location  String?
  rooms     Room[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 机房
model Room {
  id           String     @id @default(uuid())
  shortId      Int        @unique @default(autoincrement()) // 短ID
  name         String
  floor        String?
  dataCenterId String
  dataCenter   DataCenter @relation(fields: [dataCenterId], references: [id], onDelete: Cascade)
  cabinets     Cabinet[]
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

// 机柜
model Cabinet {
  id        String   @id @default(uuid())
  shortId   Int      @unique @default(autoincrement()) // 短ID
  name      String
  position  String?  // 机房中的位置
  height    Int      @default(42) // U数，默认42U
  roomId    String
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  devices   Device[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 设备类型枚举
enum DeviceType {
  SERVER
  SWITCH
  ROUTER
  FIREWALL
  STORAGE
  PDU
  OTHER
}

// 设备
model Device {
  id          String     @id @default(uuid())
  shortId     Int        @unique @default(autoincrement()) // 短ID
  name        String
  type        DeviceType
  model       String?
  serialNo    String?    @unique
  uPosition   Int?       // 在机柜中的U位
  uHeight     Int?       // 占用几U
  cabinetId   String
  cabinet     Cabinet    @relation(fields: [cabinetId], references: [id], onDelete: Cascade)
  panels      Panel[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

// 面板类型枚举
enum PanelType {
  ETHERNET
  FIBER
  POWER
  SERIAL
  USB
  OTHER
}

// 面板（设备上的接口面板）
model Panel {
  id        String    @id @default(uuid())
  name      String
  type      PanelType
  deviceId  String
  device    Device    @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  ports     Port[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// 端口状态枚举
enum PortStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  FAULTY
}

// 端口
model Port {
  id        String     @id @default(uuid())
  number    String     // 端口编号
  label     String?    // 端口标签
  status    PortStatus @default(AVAILABLE)
  panelId   String
  panel     Panel      @relation(fields: [panelId], references: [id], onDelete: Cascade)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@unique([panelId, number])
}

// 线缆类型枚举
enum CableType {
  CAT5E
  CAT6
  CAT6A
  CAT7
  FIBER_SM       // 单模光纤
  FIBER_MM       // 多模光纤
  QSFP_TO_SFP    // QSFP转SFP分支线缆
  QSFP_TO_QSFP   // QSFP直连
  SFP_TO_SFP     // SFP直连
  POWER
  OTHER
}

// 线缆（基础信息存储在关系数据库，连接关系存储在Neo4j）
model Cable {
  id          String          @id @default(uuid())
  shortId     Int             @unique @default(autoincrement()) // 短ID用于二维码
  label       String?         // 线缆标签
  type        CableType
  length      Float?          // 长度（米）
  color       String?
  notes       String?
  isBranched  Boolean         @default(false) // 是否为分支线缆（1对多）
  endpoints   CableEndpoint[] // 线缆端点
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

// 线缆端点（支持1对多连接）
model CableEndpoint {
  id        String   @id @default(uuid())
  cableId   String
  cable     Cable    @relation(fields: [cableId], references: [id], onDelete: Cascade)
  portId    String
  endType   String   // "A" 表示主端（如QSFP端），"B1", "B2", "B3", "B4" 表示分支端（如4个SFP端）
  createdAt DateTime @default(now())

  @@unique([cableId, endType]) // 确保同一线缆的端点类型唯一
}
